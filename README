OpenBlocksファームウェア作成ガイド

ぷらっとホーム株式会社

Copyright (c) 2013 Plat'Home CO., LTD.

1. はじめに

このソフトウェアを使えばOpenBlocks(AX3, A7, A6, 600)のファームウェアを作成することができます。
その内容は、シェルスクリプトとファームウェアに含めるファイルです。

2. 対応ファームウェア

ファームウェアは機種(AX3, A7, A6, 600)とOS(Debian GNU/Linux)によって異なります。
このソフトウェアが対応しているファームウェアは下の表をご覧ください。

機種 | Debian | 作成ホスト | TARGET | DIST    
=====|========|============|========|=========
AX3  | 7      | 7/amd64    | obsax3 | wheezy  
-----+--------+------------+--------+---------
AX3  | 6      | 6/amd64    | obsax3 | squeeze 
-----+--------+------------+--------+---------
A7   | 7      | 7/amd64    | obsa7  | wheezy  
-----+--------+------------+--------+---------
A6   | 7      | 7/amd64    | obsa6  | wheezy  
-----+--------+------------+--------+---------
A6   | 6      | 6/amd64    | obsa6  | squeeze 
-----+--------+------------+--------+---------
600  | 7      | 6/i386     | obs600 | wheezy  

ファームウェアを作成するホストのOSはDebian GNU/Linuxです。
そのバージョンとアーキテクチャは、ファームウェアの対象となる機種とOSによって異ります。
表の作成ホストに「バージョン/アーキテクチャ」を記述しました。

項目TARGETとDISTは、ファームウェアを作成するときに実行するシェルスクリプトに指定する文字列です。
後節で参照します。

3. 準備

3.1. 作成ホスト

前節の表で、ファームウェアを作成するホストのOSを確認してください。
例えば、機種がOpenBlocks AX3でOSがDebian 7の場合、作成ホストのOSはDebian 7/amd64です。
作成ホストを用意して、そのOSをインストールします。
物理マシンと仮想マシンのどちらでもよろしいです。
インターネットに接続できるよう、ネットワークの設定をしてください。

3.2. Gitリポジトリの取得

このソフトウェアはGitリポジトリに格納されています。

作成ホストにgit-coreパッケージをインストールします。

  # apt-get update
  # apt-get install git-core

Gitリポジトリを取得します。

  $ git clone http://git.hqlabo.plathome.co.jp/git/debian_based_firmware

以下では、ディレクトリdebian_based_firmwareに移動したものとして説明します。

3.3. クロス開発環境

ファームウェアの作成に必要なパッケージをインストールします。
機種に応じて以下のコマンドを実行してください。

3.3.1. AX3, A7, A6の場合

  # cd build_ramdisk
  # ./build_crossenv.sh

3.3.2. 600の場合

  # cd build_ramdisk
  # TARGET=obs600 ./build_crossenv.sh

3.4. カーネルソース

3.4.1. カーネルソースの取得

カーネルソースをftp.plathome.co.jpからダウンロードしてsourceディレクトリにコピーします。
ファイルbuild_ramdisk/config.shのcase文中のKERNELとPATCHLEVELからカーネルソースのFTPサイトに置いてある場所が分ります。

以下は場所の例です。

TARGET=obsax3, DIST=wheezy, KERNEL=3.2.40, PATCHLEVEL=3の場合
ftp://ftp.plathome.co.jp/pub/OBSAX3/wheezy/3.2.40-3/linux-3.2.40-20131002.tar.gz

TARGET=obsa7, DIST=wheezy, KERNEL=3.2.40, PATCHLEVEL=3の場合
ftp://ftp.plathome.co.jp/pub/OBSA7/wheezy/3.2.40-3/linux-3.2.40-20131002.tar.gz

TARGET=obsa6, DIST=wheezy, KERNEL=3.2.40, PATCHLEVEL=2の場合
ftp://ftp.plathome.co.jp/pub/OBSA6/wheezy/3.2.40-2/linux-3.2.40-20131002.tar.gz

TARGET=obsax3, DIST=squeeze, KERNEL=3.0.6, PATCHLEVEL=14の場合
ftp://ftp.plathome.co.jp/pub/OBSAX3/squeeze/3.0.6-14/source/linux-3.0.6-14.tar.gz

TARGET=obsa6, DIST=squeeze, KERNEL=2.6.31, PATCHLEVEL=8の場合
ftp://ftp.plathome.co.jp/pub/OBSA6/squeeze/2.6.31-8/source/linux-2.6.31-obs-20130131+obsa6_defconfig.tar.gz

TARGET=obs600, DIST=squeeze, KERNEL=2.6.32, PATCHLEVEL=0beta0の場合
ftp://ftp.plathome.co.jp/pub/OBS600/debian/files/wheezy/2.6.32-0beta0/linux-2.6.32-20130819-obs600.tar.gz

3.4.2. カーネルソースの展開

sourceディレクトリには、TARGETをその名前としたディレクトリがあるので、そこに展開してください。
カーネルソースの場所はディレクトリsource/TARGET/linux-KERNELとなります。

3.5. DVDイメージ

DIST=wheezyの場合、DebianのDVDイメージをダウンロードしてisofilesディレクトリにコピーします。
DIST=squeezeの場合は不要です。

ファイルbuild_ramdisk/config.shのcase文中のISOFILEからDVDイメージのファイル名が分ります。

以下はファイル名の例です。

TARGET=obsax3の場合
debian-7.1.0-armhf-DVD-1.iso

TARGET=obsa7, obsa6の場合
debian-7.1.0-armel-DVD-1.iso

TARGET=obs600の場合
debian-7.2.0-powerpc-DVD-1.iso

4. 作成

ファームウェアを作成します。
シェルスクリプトbuild_ramdisk/buildall.shのオプション-MにTARGET、-DにDISTを指定します。
TARGET=obsax3、DIST=wheezyの場合、以下の通りに実行します。

  # cd cd build_ramdisk/
  # ./buildall.sh -M obsax3 -D wheezy

作成されたファームウェア一式は、ディレクトリrelease/TARGET/DIST/KERNEL-PATCHLEVELに置かれます。

例えば、ディレクトリrelease/obsax3/wheezy/3.2.40-3には、以下のファイルが作成されます。

MD5.obsax3: MD5チェックサムファイル
System.map: カーネルのシステムマップファイル
kernel-image-3.2.40-3.deb: Debianのdpkgコマンドなどでインストールするためのファームウェア
ramdisk-wheezy.obsax3.img.lzma: ファームウェアに含まれるRAMディスクイメージ
uImage.initrd.obsax3: flashcfgコマンドでインストールするためのファームウェア
zImage.gz: ファームウェアのカーネルイメージ

5. カスタマイズ

シェルスクリプトbuild_ramdisk/buildall.shは以下の通り実行しています。
(DIST=wheezy, TARGET=obsax3の場合。)

  # DIST=wheezy TARGET=obsax3 ./build_debootstrap.sh
  # DIST=wheezy TARGET=obsax3 ./build_kernel.sh
  # DIST=wheezy TARGET=obsax3 ./build_ramdisk.sh
  # DIST=wheezy TARGET=obsax3 ./release_firmware.sh

build_debootstrap.sh: debootstrapを実行し、ディレクトリrootfs/DIST_TARGET以下に仮インストールしています。
build_kernel.sh: カーネルとカーネルモジュールのコンパイルをしています。
build_ramdisk.sh: ディレクトリrootfs/DIST_TARGET以下に仮インストールしたDebianをOpenBlocks用に変更して、RAMディスクイメージを作成しています。
release_firmware.sh: ファームウェア一式を作成しています。

上記のシェルスクリプトを手動で実行すれば、その途中で、カーネルとRAMディスクイメージのカスタマイズができます。

カスタマイズの前に、シェルスクリプトbuild_ramdisk/buildall.shを実行しておいてください。

5.1. カーネル

カーネルのコンフィグレーションを変更してカーネルをカスタマイズすることができます。

5.1.1. コンフィグレーション

カーネルソースのディレクトリsource/TARGET/linux-KERNELに移動して、コンフィグレーションを変更します。

AX3, A7, A6の場合

  # make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- menuconfig

600の場合

  # make ARCH=powerpc CROSS_COMPILE=powerpc-linux-gnu- menuconfig

5.1.2. コンフィグレーションのコピー

変更したコンフィグレーションファイル.configをコピーします。

AX3, A7, A6の場合

  # cp -a .config arch/arm/configs/TARGET_defconfig

ここでTARGETは、ご自身の文字列に置き換えてください。

600の場合

  # cp -a .config arch/powerpc/configs/obs600_defconfig

5.1.3. コンパイル

シェルスクリプトbuild_ramdisk/build_kernel.shから順番に実行するか、シェルスクリプトbuild_ramdisk/buildall.shを実行してください。
RAMディスクイメージをカスタマイズする場合、シェルスクリプトbuild_ramdisk/build_kernel.shを実行して、次節に進んでください。

5.2. RAMディスクイメージ

シェルスクリプトbuild_ramdisk/build_ramdisk.shの実行が終了すると、ディレクトリrootfs/DIST_TARGETに、RAMディスクに含まれるファイルが仮インストールされます。
ディレクトリrootfs/DIST_TARGET以下のファイルを変更したり、パッケージを追加すれば、RAMディスクイメージのカスタマイズができます。
ここでDISTとTARGETは、ご自身のものに置き換えてください。

5.2.1. パッケージの取得

追加するパッケージをダウンロードして、ディレクトリextradebs/DISTにコピーします。

5.2.2. パッケージの追加

次のコマンドを実行してパッケージを追加します。

  # DIST=wheezy TARGET=obsax3 ./08_add_extra_packages.sh

パッケージが追加されたかは、ファイルrootfs/DIST_TARGET/var/lib/dpkg/statusで確認できます。

5.2.3. RAMディスクイメージの作成

ディレクトリrootfs/DIST_TARGET以下のファイルをもとにRAMディスクイメージを作成します。

  # DIST=wheezy TARGET=obsax3 ./99_create_ramdisk.sh

ファームウェアを作成します。

  # DIST=wheezy TARGET=obsax3 ./release_firmware.sh
