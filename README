OpenBlocksファームウェア作成ガイド

ぷらっとホーム株式会社

Copyright (c) 2013, 2014 Plat'Home CO., LTD.

1. はじめに

このソフトウェアを使えばOpenBlocks(AX3, A7, A6, 600)のファームウェア
を作成することができます。内容は、シェルスクリプトとファームウェアに
含めるファイルです。

2. 対応ファームウェア

OpenBlocksのファームウェアは、機種(AX3, A7, A6, 600)とOS(Debian
GNU/Linux)によって異なります。対応しているファームウェアは下の表をご
覧ください。

機種 | Debian | 作成ホスト | TARGET | DIST    | ARCH
=====|========|============|========|=========|========
AX3  | 7      | 7/amd64    | obsax3 | wheezy  | armhf
-----+--------+------------+--------+---------|--------
AX3  | 6      | 6/amd64    | obsax3 | squeeze | armel
-----+--------+------------+--------+---------|--------
A7   | 7      | 7/amd64    | obsa7  | wheezy  | armel
-----+--------+------------+--------+---------|--------
A6   | 7      | 7/amd64    | obsa6  | wheezy  | armel
-----+--------+------------+--------+---------|--------
A6   | 6      | 6/amd64    | obsa6  | squeeze | armel
-----+--------+------------+--------+---------|--------
600  | 7      | 7/amd64    | obs600 | wheezy  | powerpc

ファームウェアを作成するホストのOSはDebian GNU/Linuxです。そのバージ
ョンとアーキテクチャは、ファームウェアの対象となる機種とOSによって異
ります。表の作成ホストに「バージョン/アーキテクチャ」を記述しました。

項目TARGETとDISTは、ファームウェアを作成するときに実行するシェルスク
リプトに指定する文字列です。後節で参照します。

3. 準備

3.1. 作成ホスト

前節の表で、ファームウェアを作成するホストのOSを確認してください。例
えば、機種がOpenBlocks AX3でOSがDebian 7の場合、作成ホストのOSは
Debian 7/amd64です。ホストを用意して、そのOSをインストールします。ホ
ストは物理マシンと仮想マシンのどちらでもよろしいです。インターネット
に接続できるよう、ネッワークの設定をしてください。

3.2. Gitリポジトリの取得

このソフトウェアはGitリポジトリから取得できます。

作成ホストにgitパッケージをインストールします。

  # apt-get update
  # apt-get install git

Gitリポジトリを取得します。

  $ git clone git://github.com/plathome/debian_based_firmware.git

以下では、ディレクトリdebian_based_firmwareに移動したものとして説明し
ます。

3.3. クロス開発環境

ファームウェアの作成に必要なパッケージをインストールします。機種に応
じて以下のコマンドを実行してください。

3.3.1. AX3, A7, A6

  # cd build_ramdisk
  # ./build_crossenv.sh

3.3.2. 600

  # cd build_ramdisk
  # TARGET=obs600 ./build_crossenv.sh

3.4. カーネルソース

3.4.1. 取得

カーネルソースをぷらっとホームのFTPサイトftp.plathome.co.jpからダウン
ロードします。ファイルbuild_ramdisk/config.shのcase文中のKERNELと
PATCHLEVELからカーネルソースのFTPサイトに置いてある場所が分ります。

以下は場所の例です。

TARGET=obsax3, DIST=wheezy, KERNEL=3.2.40, PATCHLEVEL=4の場合
ftp://ftp.plathome.co.jp/pub/OBSAX3/wheezy/3.2.40-4/linux-3.2.40-20140220.tar.gz

TARGET=obsa7, DIST=wheezy, KERNEL=3.2.40, PATCHLEVEL=4の場合
ftp://ftp.plathome.co.jp/pub/OBSA7/wheezy/3.2.40-4/linux-3.2.40-20140220.tar.gz

TARGET=obsa6, DIST=wheezy, KERNEL=3.2.40, PATCHLEVEL=3の場合
ftp://ftp.plathome.co.jp/pub/OBSA6/wheezy/3.2.40-3/linux-3.2.40-20140220.tar.gz

TARGET=obsax3, DIST=squeeze, KERNEL=3.0.6, PATCHLEVEL=14の場合
ftp://ftp.plathome.co.jp/pub/OBSAX3/squeeze/3.0.6-14/source/linux-3.0.6-14.tar.gz

TARGET=obsa6, DIST=squeeze, KERNEL=2.6.31, PATCHLEVEL=8の場合
ftp://ftp.plathome.co.jp/pub/OBSA6/squeeze/2.6.31-8/source/linux-2.6.31-obs-20130131+obsa6_defconfig.tar.gz

TARGET=obs600, DIST=wheezy, KERNEL=3.10.25, PATCHLEVEL=0の場合
ftp://ftp.plathome.co.jp/pub/OBS600/debian/files/wheezy/3.10.25-0/linux-3.10.25-obs600.tar.gz

3.4.2. 展開

ディレクトリsourceには、TARGETをその名前としたディレクトリがあるので、
そこにカーネルソースを展開してください。その結果、ディレクトリ
source/TARGET/linux-KERNELが作成されます。TARGETとKERNELは、ご自身の
文字列に置き換えてください。

3.5. DVDイメージ

DIST=wheezyの場合、DebianのDVDイメージをDebianのミラーサイトからダウ
ンロードしてディレクトリisofilesにコピーします。DIST=squeezeの場合は
不要です。

ファイルbuild_ramdisk/config.shのcase文中のISOFILEからDVDイメージのフ
ァイル名が分ります。

以下はファイル名の例です。

TARGET=obsax3の場合
debian-7.1.0-armhf-DVD-1.iso

TARGET=obsa7, obsa6の場合
debian-7.1.0-armel-DVD-1.iso

TARGET=obs600の場合
debian-7.4.0-powerpc-DVD-1.iso

これらのファイルは 
ftp://ftp.plathome.co.jp/pub/cdimages/debian/
から取得できます。

4. 作成

ファームウェアを作成します。シェルスクリプトbuild_ramdisk/buildall.sh
のオプション-MにTARGET、-DにDISTを指定します。TARGET=obsax3、
DIST=wheezyの場合、

  # cd build_ramdisk
  # ./buildall.sh -M obsax3 -D wheezy

と実行します。

作成されたファームウェア一式は、ディレクトリ
release/TARGET/DIST/KERNEL-PATCHLEVELに置かれます。TARGET, DIST,
KERNEL, PATCHLEVELは、ご自身の文字列に置き換えてください。

例えば、ディレクトリrelease/obsax3/wheezy/3.2.40-3には、以下のファイ
ルが作成されます。

o MD5.obsax3: MD5チェックサムファイル
o System.map: カーネルのシステムマップファイル
o kernel-image-3.2.40-3.deb: コマンドdpkgなどでインストールするための
  パッケージ
o ramdisk-wheezy.obsax3.img.lzma: ファームウェアのRAMディスクイメージ
o uImage.initrd.obsax3: コマンドflashcfgでインストールするためのファ
  ームウェア
o zImage.gz: ファームウェアのカーネルイメージ

5. カスタマイズ

本節ではファームウェアのカスタマイズの手順を説明します。

シェルスクリプトbuild_ramdisk/buildall.shを実行することは、
DIST=wheezy, TARGET=obsax3の場合、以下の通り実行することと同じです。

  # DIST=wheezy TARGET=obsax3 ./build_debootstrap.sh
  # DIST=wheezy TARGET=obsax3 ./build_kernel.sh
  # DIST=wheezy TARGET=obsax3 ./build_ramdisk.sh
  # DIST=wheezy TARGET=obsax3 ./release_firmware.sh

TARGETとDISTについては、予め次のように設定することで、毎回の指定は不要
になります。

  # export DIST=wheezy TARGET=obsax3

内容の詳細は各シェルスクリプトを読んでいただくことにして、簡単に説明し
ておきます。以下のTARGETとDISTは、ご自身の文字列に置き換えてください。

o build_debootstrap.sh: debootstrapを実行し、ディレクトリ
  rootfs/DIST_TARGET以下にDebianを仮インストールしています。
o build_kernel.sh: カーネルとカーネルモジュールのコンパイルをしていま
す。
o build_ramdisk.sh: ディレクトリrootfs/DIST_TARGET以下に仮インストー
  ルしたDebianをOpenBlocks用に変更して、RAMディスクイメージを作成して
  います。
o release_firmware.sh: ファームウェア一式を作成しています。

上記のシェルスクリプトを手動で実行すれば、その途中で、カーネルとRAMデ
ィスクイメージのカスタマイズができます。

ファイルbuild_ramdisk/config.shのcase文中のPATCHLEVELには文字列などを
追加、例えば3customとすることをお勧めします。公式ファームウェアとの区
別がはっきりします。

カスタマイズの前に、その準備として、シェルスクリプト
build_ramdisk/buildall.shを実行しておいてください。

5.1. カーネル

カーネルのコンフィグレーションを変更してカーネルをカスタマイズするこ
とができます。
カーネルをカスタマイズしない場合には、「5.2. RAMディスクイメージ」節
に進んでください。

5.1.1. コンフィグレーションの変更

次のコマンドを実行して、カーネルのコンフィグレーションを変更します。
TARGETとDISTは、ご自身の文字列に置き換えてください。

  # DIST=wheezy TARGET=obsax3 ./kernel_menuconfig.sh

変更したコンフィグレーションファイルは
source/TARGET/linux-KERNEL.dot.configにコピーされます。TARGETとKERNEL
は、ご自身の文字列に置き換えてください。

5.1.2. コンパイル

シェルスクリプトbuild_ramdisk/build_kernel.shから順番に実行するか、シ
ェルスクリプトbuild_ramdisk/buildall.shを実行してください。RAMディス
クイメージをカスタマイズする場合、シェルスクリプト
build_ramdisk/build_kernel.shを実行して、次節に進んでください。

5.2. RAMディスクイメージ

シェルスクリプトbuild_ramdisk/build_ramdisk.shの実行が終了すると、デ
ィレクトリrootfs/DIST_TARGETに、RAMディスクに含まれるファイルが仮イン
ストールされます。ディレクトリrootfs/DIST_TARGET以下のファイルを変更
したり、パッケージを追加すれば、RAMディスクイメージのカスタマイズがで
きます。DISTとTARGETは、ご自身のものに置き換えてください。

5.2.1. パッケージの取得

追加するパッケージをDebianのミラーサイトからダウンロードして、ディレ
クトリextradebs/DISTにコピーします。DISTは、ご自身の文字列に置き換え
てください。

5.2.2. パッケージの追加

次のコマンドを実行してパッケージを追加します。DIST=wheezy,
TARGET=obsax3の場合、

  # DIST=wheezy TARGET=obsax3 ./08_add_extra_packages.sh

と実行します。

パッケージが追加されたかは、ファイル
rootfs/DIST_TARGET/var/lib/dpkg/statusで確認できます。TARGETとDISTは、
ご自身の文字列に置き換えてください。

5.2.3. RAMディスクイメージの作成

ディレクトリrootfs/DIST_TARGET以下のファイルをもとにRAMディスクイメー
ジを作成します。TARGETとDISTは、ご自身の文字列に置き換えてください。
DIST=wheezy, TARGET=obsax3の場合、

  # DIST=wheezy TARGET=obsax3 ./99_create_ramdisk.sh

と実行します。

ファームウェアを作成します。DIST=wheezy, TARGET=obsax3の場合、

  # DIST=wheezy TARGET=obsax3 ./release_firmware.sh

と実行します。

5.3. まとめ

一度「5.1.1. コンフィグレーションの変更」と「5.2.1. パッケージの取得」
をすませておけば、シェルスクリプトbuild_ramdisk/buildall.shを実行する
だけでカスタマイズのすんだファームウェアが作成できます。

6. ファームウェアの更新

ファームウェアuImage.initrd.TARGETをOpenBlocksにネットワーク経由もし
くはUSBメモリでコピーしてください。TARGETは、ご自身の文字列に置き換え
てください。

次のコマンド

  # flashcfg -f uImage.initrd.TARGET

を実行し、再起動すれば、ファームウェアの更新は終了です。

7. TFTPサーバを使った起動

ファームウェアをカスタマイズする過程においては、前節のやり方でファー
ムウェアを更新するよりも、TFTPサーバを使ってOpenBlocksを起動した方が
便利です。

起動できないファームウェアに更新してしまったとしても、ここで説明する
方法で復旧できます。

7.1. TFTPサーバの構築

7.1.1. インストール

ファームウェアを作成するホストで、以下のコマンド

  # apt-get update
  # apt-get install tftpd
  # /etc/init.d/openbsd-inetd restart

を実行して、TFTPサーバをインストールします。

7.1.2. ファームウェアの準備

ディレクトリ/srv/tftpを作成し、ファームウェアuImage.initrd.TARGETを
コピーします。TARGETは、ご自身の文字列に置き換えてください。

ファイル名は、固定なので、変更しないでください。600だけは
uImage.initrdにします。

7.2. OpenBlocksの起動

7.2.1. 準備

OpenBlocksの電源を切っておきます。ETHER-0ポートに、TFTPサーバと通信
できるネットワークからのイーサネットケーブルを接続します。

シリアルコンソールを接続してから、電源を入れ、U-Bootのプロンプトが出
るまで、適当なキー(例えば、スペースキー)を押し続けます。DIPスイッチ
の1をONにすれば、電源を入れた後、U-Bootのプロンプトを出して止まるよ
うになります。

以下では、U-Bootのプロンプトを「>」で示します。

7.2.2. ネットワーク設定

DHCPサーバを利用する場合は、次のコマンド

  > dhcp

を実行します。固定IPアドレスの場合は、以下のように設定します。

  > setenv ipaddr 192.168.254.254
  > setenv netmask 255.255.255.0
  > setenv gatewayip 192.168.254.1

TFTPサーバのIPアドレスを設定します。

  > setenv tftpserver 192.168.254.3

設定の確認は

  > printenv

設定の保存は

  > saveenv

設定の消去は

  > resetenv (600以外)
  > clr_env  (600のみ)
  > reset

を実行します。

7.2.3. FlashROMに保存しないで起動

ファームウェアをFlashROMに保存しないで起動する場合、次のコマンド

  > run os_load_boot

を実行します。

次回再起動時にはFlashROMに保存されているファームウェアで起動します。

7.2.4. FlashROMに保存してから起動

ファームウェアをFlashROMに保存してから起動する場合、次のコマンド

  > run os_load_prog
  > reset

を実行します。
